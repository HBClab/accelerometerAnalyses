---
title: "GGIR post-processing for subject-level summary data"
output: html_notebook
---

* Purpose: extract and summarize variables of interest from person summaries generated by part5 of GGIR

* Output: 
- summary descriptives of average daily PA by intensity level for each particpant


```{r message=FALSE, warning=FALSE, include=FALSE}

rm(list=ls(all=TRUE))  #clear previous

library(ggplot2)
library(Hmisc)
library(psych)
library(tidyverse)
```


# define source and targets of person-level summaries
```{r}
### set paths
# where the sub-### source files for personsummary files 
# end in / - will be used later for splitting (this may be just for windows?)
ProjectDir<-"/Volumes/vosslabhpc/Projects/BikeExtend/3-Experiment/2-Data/BIDS/derivatives/GGIR"

# where the output folders will go
ProjectDerivDir<-"/Volumes/vosslabhpc/Projects/BikeExtend/3-Experiment/2-Data/BIDS/derivatives/GGIR_summary"
```


## gather subject directories
  - could try to search within a session of interest
```{r}
# list directories in ProjectDir
  # can this be faster
directories <- list.dirs(ProjectDir, recursive = FALSE)
load("GGIRfiles.RData")

directories <- GGIRfiles

# list only sub-directories that contain string "sub-"
subdirs <- directories[grepl("sub-*", directories)]
```


## gather files of interest per subject and session
  - can this be more efficient by giving file path that is closer to the target file
```{r}

# re-run AFTER GGIR has been updated for a given batch of subjects & sessions

# target file pattern
filepattern<-"part5_personsummary_MM_L45M100V430_T5A5.csv"

# list to fill
GGIRfiles = list()

# look within subdirs for files matching target pattern
GGIRfiles <- list.files(subdirs,
                        pattern=filepattern,
                        recursive=TRUE,
                        include.dirs=TRUE,
                        full.names=TRUE,
                        no..=TRUE)

# save file list for reference
save(GGIRfiles, file="GGIRfiles.RData")


```



# read in files as list structure and load .csv's 

  
```{r}

# empty data frame to hold person-by-person data collected in loop below
personsummary_df <- data.frame()

# GGIR files pre
GGIRfiles_pre <- GGIRfiles[grepl("ses-accel1", GGIRfiles)]


# for each file listed in GGIRfiles, read in as .csv, extract data of interest, add on to dataframe
for (f in GGIRfiles_pre) {
    dat <- read.csv(file = f, header = TRUE, sep = ",", fill = TRUE)
    dat_summary = dat[grep("(*dur_day_total.*(IN_min_pla|LIG_min_pla|MOD_min_pla|VIG_min_pla)|*Nvaliddays|filename)", x=names(dat))]
    personsummary_df <<- rbind(personsummary_df,dat_summary)
  }

# use filename to make new variables for subject and session, create a MODVIG variable
personsummary_df <- personsummary_df %>%
  separate(col= filename, sep="_", into = c("subject_id", "session", "ext")) %>%
  select(-ext) %>%
  mutate(dur_day_total_MODVIG_min_pla=dur_day_total_MOD_min_pla+dur_day_total_VIG_min_pla) 

# clean up variable names for subject and session
personsummary_df$subject_id = gsub(pattern = "sub-", replacement = "", x = personsummary_df$subject_id)  
personsummary_df$session = gsub(pattern = "ses-", replacement = "", x = personsummary_df$session)  

```

    
# write out to inspect descriptives with jamovi
 
```{r}
personsummary_df_pre <- personsummary_df %>%
  filter(session=="accel1")
write.csv(personsummary_df_pre, file = "BikeExtend_personsummary_accel1.csv", row.names = FALSE)


```
 
 
```{r}

library(jmv)
jmv::descriptives(
    data = personsummary_df_pre,
    vars = vars(Nvaliddays_WD, Nvaliddays, Nvaliddays_WE),
    freq = TRUE,
    dotType = "stack")
```
 
```{r}
jmv::descriptives(
    data = personsummary_df_pre,
    vars = vars(dur_day_total_IN_min_pla, dur_day_total_LIG_min_pla, dur_day_total_MOD_min_pla, dur_day_total_VIG_min_pla, dur_day_total_MODVIG_min_pla),
    hist = TRUE,
    sd = TRUE,
    skew = TRUE)
```
    
    